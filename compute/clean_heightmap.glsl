# version 430

layout(local_size_x = 32, local_size_y = 32, local_size_z = 1) in;

// TODO Make these uniforms
const int EXTENTS = 16;                         // Extents of SDF block, in distance units
const int DIVISIOINS = 16;                       // Cells per distance unit
const int   HMAP_EXTENTS = EXTENTS*DIVISIOINS;     // Extents of SDF block, in number of cells

// Kernel navigation constants
const int K_SIZE = 9;
const int K_SIZE_2 = K_SIZE*K_SIZE;
const int K_SIZE_1_2 = int((K_SIZE-1)*0.5);
const float K_SIZE_INV = 1.0/K_SIZE;

layout(location = 0) uniform ivec3 sdf_index;
layout(std430, binding = 1) volatile buffer sdf { float sdf_buffer[256][256]; };
layout(std430, binding = 3) volatile buffer score { float score_buffer[256][256]; };

float kernel[K_SIZE][K_SIZE] = {{3.8940039153570245 ,4.112887811993323 ,4.276726636537113 ,4.378146286017691 ,4.412484512922977 ,4.378146286017691 ,4.276726636537113 ,4.112887811993323 ,3.8940039153570245 ,},
{4.112887811993323 ,4.344075281314216 ,4.5171235676654335 ,4.624244066081024 ,4.660512461797638 ,4.624244066081024 ,4.5171235676654335 ,4.344075281314216 ,4.112887811993323},
{4.276726636537113 ,4.5171235676654335 ,4.697065314067379 ,4.808453008027127 ,4.846166172381721 ,4.808453008027127 ,4.697065314067379 ,4.5171235676654335 ,4.276726636537113},
{4.378146286017691 ,4.624244066081024 ,4.808453008027127 ,4.922482185027042 ,4.9610896913012175 ,4.922482185027042 ,4.808453008027127 ,4.624244066081024 ,4.378146286017691},
{4.412484512922977 ,4.660512461797638 ,4.846166172381721 ,4.9610896913012175 ,5.0               ,4.9610896913012175 ,4.846166172381721 ,4.660512461797638 ,4.412484512922977},
{4.378146286017691 ,4.624244066081024 ,4.808453008027127 ,4.922482185027042 ,4.9610896913012175 ,4.922482185027042 ,4.808453008027127 ,4.624244066081024 ,4.378146286017691},
{4.276726636537113 ,4.5171235676654335 ,4.697065314067379 ,4.808453008027127 ,4.846166172381721 ,4.808453008027127 ,4.697065314067379 ,4.5171235676654335 ,4.276726636537113},
{4.112887811993323 ,4.344075281314216 ,4.5171235676654335 ,4.624244066081024 ,4.660512461797638 ,4.624244066081024 ,4.5171235676654335 ,4.344075281314216 ,4.112887811993323},
{3.8940039153570245 ,4.112887811993323 ,4.276726636537113 ,4.378146286017691 ,4.412484512922977 ,4.378146286017691 ,4.276726636537113 ,4.112887811993323 ,3.8940039153570245}};

// {{0.36787944117144233 ,0.4856717852477124 ,0.5737534207374327 ,0.6065306597126334 ,0.5737534207374327 ,0.4856717852477124 ,0.36787944117144233},
// {0.4856717852477124 ,0.6411803884299546 ,0.7574651283969664 ,0.8007374029168081 ,0.7574651283969664 ,0.6411803884299546 ,0.4856717852477124},
// {0.5737534207374327 ,0.7574651283969664 ,0.8948393168143698 ,0.9459594689067654 ,0.8948393168143698 ,0.7574651283969664 ,0.5737534207374327},
// {0.6065306597126334 ,0.8007374029168081 ,0.9459594689067654 ,1.0                ,0.9459594689067654 ,0.8007374029168081 ,0.6065306597126334},
// {0.5737534207374327 ,0.7574651283969664 ,0.8948393168143698 ,0.9459594689067654 ,0.8948393168143698 ,0.7574651283969664 ,0.5737534207374327},
// {0.4856717852477124 ,0.6411803884299546 ,0.7574651283969664 ,0.8007374029168081 ,0.7574651283969664 ,0.6411803884299546 ,0.4856717852477124},
// {0.36787944117144233 ,0.4856717852477124 ,0.5737534207374327 ,0.6065306597126334 ,0.5737534207374327 ,0.4856717852477124 ,0.36787944117144233}};

// {{0.36787944117144233 ,0.45783336177161427 ,0.5352614285189903 ,0.5878696731223465 ,0.6065306597126334 ,0.5878696731223465 ,0.5352614285189903 ,0.45783336177161427 ,0.36787944117144233},
// {0.45783336177161427 ,0.569782824730923 ,0.6661436107034878 ,0.7316156289466418 ,0.7548396019890073 ,0.7316156289466418 ,0.6661436107034878 ,0.569782824730923 ,0.45783336177161427},
// {0.5352614285189903 ,0.6661436107034878 ,0.7788007830714049 ,0.8553453273074225 ,0.8824969025845955 ,0.8553453273074225 ,0.7788007830714049 ,0.6661436107034878 ,0.5352614285189903},
// {0.5878696731223465 ,0.7316156289466418 ,0.8553453273074225 ,0.9394130628134758 ,0.9692332344763441 ,0.9394130628134758 ,0.8553453273074225 ,0.7316156289466418 ,0.5878696731223465},
// {0.6065306597126334 ,0.7548396019890073 ,0.8824969025845955 ,0.9692332344763441 ,1.0                ,0.9692332344763441 ,0.8824969025845955 ,0.7548396019890073 ,0.6065306597126334},
// {0.5878696731223465 ,0.7316156289466418 ,0.8553453273074225 ,0.9394130628134758 ,0.9692332344763441 ,0.9394130628134758 ,0.8553453273074225 ,0.7316156289466418 ,0.5878696731223465},
// {0.5352614285189903 ,0.6661436107034878 ,0.7788007830714049 ,0.8553453273074225 ,0.8824969025845955 ,0.8553453273074225 ,0.7788007830714049 ,0.6661436107034878 ,0.5352614285189903},
// {0.45783336177161427 ,0.569782824730923 ,0.6661436107034878 ,0.7316156289466418 ,0.7548396019890073 ,0.7316156289466418 ,0.6661436107034878 ,0.569782824730923 ,0.45783336177161427},
// {0.36787944117144233 ,0.45783336177161427 ,0.5352614285189903 ,0.5878696731223465 ,0.6065306597126334 ,0.5878696731223465 ,0.5352614285189903 ,0.45783336177161427 ,0.36787944117144233}
// }

float calculate_score(uint x, uint y)
{
    // Gradient score
    uint ym = uint(mod(y, HMAP_EXTENTS));
    uint xm = uint(mod(x, HMAP_EXTENTS));
    uint ym1 = uint(mod(y-1, HMAP_EXTENTS));
    uint xm1 = uint(mod(x-1, HMAP_EXTENTS));
    uint yp1 = uint(mod(y+1, HMAP_EXTENTS));
    uint xp1 = uint(mod(x+1, HMAP_EXTENTS));

    float g_x = 0.5*(sdf_buffer[xm1][ym1]   - sdf_buffer[xp1][ym1]
                    +2*sdf_buffer[xm1][ym]  - 2*sdf_buffer[xp1][ym]
                    +sdf_buffer[xm1][yp1]   - sdf_buffer[xp1][yp1]);
    
    float g_y = 0.5*(sdf_buffer[xm1][ym1]   + 2*sdf_buffer[xm][ym1]     + sdf_buffer[xp1][ym1]
                    -sdf_buffer[xm1][yp1]   - 2*sdf_buffer[xm][yp1]     - sdf_buffer[xp1][yp1]);

    float steepness_score = sqrt(g_x*g_x + g_y*g_y);


    // Proximity score
    float prox_score = 0.0;
    // nested loops are funky here
    for(int i=0; i<K_SIZE_2; i++)
    {   
        int iroll = int(i*(K_SIZE_INV));
        int jroll = int(mod(i, K_SIZE));
        prox_score += kernel[iroll][jroll]*(sdf_buffer[x-K_SIZE_1_2+iroll][y-K_SIZE_1_2+jroll] - sdf_buffer[x][y]);
    }
    prox_score = abs(prox_score/(K_SIZE_2));
    return prox_score + steepness_score;
}


void main()
{
    uint x = gl_GlobalInvocationID.x;
    uint y = gl_GlobalInvocationID.y;
    score_buffer[x][y] = calculate_score(x,y);
    if  ( HMAP_EXTENTS-sdf_index.x == x ||   HMAP_EXTENTS-sdf_index.y == y)
    {
        sdf_buffer[x][y] = 0.0;
    }
}